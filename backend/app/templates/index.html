<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mammal Database</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .navbar-dark .navbar-nav .nav-link {
            color: #f8f9fa; 
        }
        .navbar-dark .navbar-nav .nav-link:hover {
            color: #ADD8E6; 
        }
    </style>
</head>
<body>
    <!-- Navigation bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">MammalDB</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                         <!-- Login link which triggers modal -->
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal" id="loginLink">Login</a>
                    </li>
                    <li class="nav-item" style="display:none;">
                        <a class="nav-link" href="/logout" id="logoutLink">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Login -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">User Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username:</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password:</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                        <button type="button" class="btn btn-link" data-bs-target="#registerModal" data-bs-toggle="modal" data-bs-dismiss="modal">Register a new account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutModalLabel">Logout Confirmation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to logout?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmLogout">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">User Registration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="newUsername" class="form-label">Username:</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Password:</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newEmail" class="form-label">Email:</label>
                            <input type="email" class="form-control" id="newEmail" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-5">
        <h2>Welcome to the Mammal Database</h2>
        <p>Discover and learn more about the fascinating world of mammals.</p>

         <!-- Search form -->
        <form id="searchForm">
            <input type="text" name="search_term" class="form-control" placeholder="Enter search term">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="search_type" id="searchByName" value="name" checked>
                <label class="form-check-label" for="searchByName">
                    By Name
                </label>

            
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="search_type" id="searchByCountry" value="country">
                <label class="form-check-label" for="searchByCountry">By Country</label>
            </div>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="search_type" id="searchByContinent" value="continent">
                <label class="form-check-label" for="searchByContinent">By Continent</label>
            </div>



            <button type="button" class="btn btn-primary mt-3" onclick="submitSearch()">Search</button>
        </form>

        <!-- Search results container -->
        <div id="searchResults" class="mt-3">
      
        </div>
    </div>
    <script>
        $(document).ready(function() {
            // Function to update the navigation bar based on user's login status
            function updateNavbar() {
                var username = localStorage.getItem('username');
                if (username) {
                    $('#loginLink').text(username)
                        .off('click')  
                        
                        .on('click', function(event) {
                            event.preventDefault(); 
                            $('#logoutModal').modal('show');
                        })
                        .removeAttr('data-bs-toggle')  
                        .removeAttr('data-bs-target');
                        
                    $('#logoutLink').show();
                } else {
                    $('#loginLink').text('Login')
                        .off('click')  
                   
                        .on('click', function(event) {
                            event.preventDefault();
                            $('#loginModal').modal('show');
                        })
                        .attr('data-bs-toggle', 'modal')
                        .attr('data-bs-target', '#loginModal');
                        
                    $('#logoutLink').hide();
                }
            }
        
            // login form submission
            $('#loginForm').on('submit', function(event) {
                event.preventDefault();
                var username = $('#username').val();
                var password = $('#password').val();
        
                $.ajax({
                    url: '/login',
                    type: 'GET',
                    data: { username: username, password: password },
                    success: function(response) {
                        localStorage.setItem('username', username);  
                        updateNavbar();
                        $('#loginModal').modal('hide'); 
                        alert('Login Success!');
                    },
                    error: function(xhr) {
                        alert('Login Failed: ' + xhr.responseText);
                    }
                });
            });
        
            // registration form submission
            $('#registerForm').on('submit', function(event) {
                event.preventDefault();
                var newUsername = $('#newUsername').val();
                var newPassword = $('#newPassword').val();
                var newEmail = $('#newEmail').val();
        
                $.ajax({
                    url: '/register',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        username: newUsername,
                        password: newPassword,
                        email: newEmail
                    }),
                    success: function(response) {
                        alert('Register Success，please login!');
                        $('#registerModal').modal('hide');
                        $('#loginModal').modal('show');
                    },
                    error: function(response) {
                        alert('Register Failed: ' + response.responseJSON.error);
                    }
                });
            });
        
            // logout confirmation
            $('#confirmLogout').click(function() {
                localStorage.removeItem('username'); 
                updateNavbar();  
                $('#logoutModal').modal('hide');  
                alert('You have logged out!');
            });
        
            updateNavbar();  
        });
        // search form submission and display results
        function submitSearch() {
            var searchType = $('input[name="search_type"]:checked').val();
            var searchTerm = $('input[name="search_term"]').val();
            var url = '/' + (searchType === 'name' ? 'searchname' : searchType === 'country' ? 'searchcountry' : 'searchcontinent');
            
            $.ajax({
                url: url,
                type: 'GET',
                data: {[searchType === 'name' ? 'mammal_name' : searchType === 'country' ? 'country_name' : 'continent_name']: searchTerm},
                dataType: 'json',
                success: function(response) {
                    var html = "";
                    if (response.results && response.results.length > 0) {
                        response.results.forEach(function(item) {
                            html += "<div class='mammal-item'>";
                            html += "<h4>" + item.SciName + "</h4>";
                            html += "<p>Genus: " + item.GenusName + "</p>";
                            html += "<p>Family: " + item.FamilyName + "</p>";
                            html += "<p>Order: " + item.OrderName + "</p>";
                            html += "<p>Extinct: " + (item.Extinct ? "Yes" : "No") + "</p>";
                            html += "</div>";
                        });
                    } else {
                        html = "<p>No mammals found.</p>";
                    }
                    $('#searchResults').html(html);
                },
                error: function(xhr, status, error) {
                    $('#searchResults').html('<div class="alert alert-danger">' + error + '</div>');
                }
            });
        }
    </script>
</body>
</html>
